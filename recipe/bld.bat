@echo on

:: Delegate to the Unixy script. We need to translate the key path variables
:: to be Unix-y rather than Windows-y, though.
set "saved_recipe_dir=%RECIPE_DIR%"
set "saved_source_dir=%SRC_DIR%"

FOR /F "delims=" %%i IN ('cygpath.exe -u "%PYTHON%"') DO set "BAZEL_PYTHON=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%LIBRARY_PREFIX%\usr\bin\bash.exe"') DO set "BAZEL_SH=%%i"

::FOR /F "delims=" %%i IN ('cygpath.exe -u -p "%PATH%"') DO set "PATH_OVERRIDE=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%LIBRARY_PREFIX%"') DO set "LIBRARY_PREFIX=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%PREFIX%"') DO set "PREFIX=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%PYTHON%"') DO set "PYTHON=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%RECIPE_DIR%"') DO set "RECIPE_DIR=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%SP_DIR%"') DO set "SP_DIR=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%SRC_DIR%"') DO set "SRC_DIR=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%STDLIB_DIR%"') DO set "STDLIB_DIR=%%i"

:: LIBRARY_PREFIX gets translated to '/' instead of the absolute path
FOR /F "delims=" %%i IN ('cygpath.exe -u "%PREFIX%"') DO set "JAVA_HOME=%%i/Library"

:: Need a very short TMPDIR otherwise we hit the max path limit while compiling bazel
FOR /F "delims=" %%i IN ('cygpath.exe -u "%SYSTEMDRIVE%\t"') DO set "TMPDIR=%%i"
FOR /F "delims=" %%i IN ('cygpath.exe -u "%SYSTEMDRIVE%\t"') DO set "TEMP=%%i"

set MSYSTEM=MINGW%ARCH%
set MSYS2_PATH_TYPE=inherit
set CHERE_INVOKING=1
set "BAZEL_VC=%VSINSTALLDIR%VC"
set "BAZEL_VS=%VSINSTALLDIR%"
set "EXTRA_BAZEL_ARGS=--tool_java_runtime_version=21 --java_runtime_version=21"

:: TODO: Can probably remove this whole list once we get this package building in PBP since the reconstructed CBC that
::       PBP will make should be very small.

:: We need to unset some environment variables to make the java command line short enough
set AGENT_CLOUDID=
set AGENT_DISABLELOGPLUGIN_TESTFILEPUBLISHERPLUGIN=
set AGENT_DISABLELOGPLUGIN_TESTRESULTLOGPLUGIN=
set AGENT_ENABLE_PIPELINEARTIFACT_LARGE_CHUNK_SIZE=
set AGENT_HOMEDIRECTORY=
set AGENT_ID=
set AGENT_ISSELFHOSTED=
set AGENT_JOBNAME=
set AGENT_JOBSTATUS=
set AGENT_LOGTOBLOBSTORAGESERVICE=
set AGENT_MACHINENAME=
set AGENT_NAME=
set AGENT_OS=
set AGENT_OSARCHITECTURE=
set AGENT_READONLYVARIABLES=
set AGENT_RETAINDEFAULTENCODING=
set AGENT_ROOTDIRECTORY=
set AGENT_SERVEROMDIRECTORY=
set AGENT_TASKRESTRICTIONSENFORCEMENTMODE=
set AGENT_TEMPDIRECTORY=
set AGENT_TOOLSDIRECTORY=
set AGENT_USEWORKSPACEID=
set AGENT_VERSION=
set AGENT_WORKFOLDER=
set ANDROID_HOME=
set ANDROID_NDK=
set ANDROID_NDK_HOME=
set ANDROID_NDK_LATEST_HOME=
set ANDROID_NDK_PATH=
set ANDROID_NDK_ROOT=
set ANDROID_SDK_ROOT=
set ANT_HOME=
set AZURE_CONFIG_DIR=
set AZURE_DEVOPS_CACHE_DIR=
set AZURE_DEVOPS_EXT_CONFIG_DIR=
set AZURE_EXTENSION_DIR=
set AZURE_HTTP_USER_AGENT=
set AZP_75787_ENABLE_COLLECT=
set AZP_75787_ENABLE_NEW_LOGIC=
set AZP_75787_ENABLE_NEW_LOGIC_LOG=
set AZP_75787_ENABLE_NEW_PH_LOGIC=
set AZP_AGENT_CHECK_FOR_TASK_DEPRECATION=
set AZP_AGENT_IGNORE_VSTSTASKLIB=
set AZP_AGENT_LOG_TASKNAME_IN_USERAGENT=
set AZP_AGENT_MOUNT_WORKSPACE=
set AZP_ENABLE_RESOURCE_MONITOR_DEBUG_OUTPUT=
set AZP_PS_ENABLE_INVOKE_PROCESS=
set BUILD_ARTIFACTSTAGINGDIRECTORY=
set BUILD_BINARIESDIRECTORY=
set BUILD_BUILDID=
set BUILD_BUILDNUMBER=
set BUILD_BUILDURI=
set BUILD_CONTAINERID=
set BUILD_DEFINITIONFOLDERPATH=
set BUILD_DEFINITIONNAME=
set BUILD_DEFINITIONVERSION=
set BUILD_QUEUEDBY=
set BUILD_QUEUEDBYID=
set BUILD_REASON=
set BUILD_REPOSITORY_CLEAN=
set BUILD_REPOSITORY_GIT_SUBMODULECHECKOUT=
set BUILD_REPOSITORY_ID=
set BUILD_REPOSITORY_LOCALPATH=
set BUILD_REPOSITORY_NAME=
set BUILD_REPOSITORY_PROVIDER=
set BUILD_REPOSITORY_URI=
set BUILD_REQUESTEDFOR=
set BUILD_REQUESTEDFOREMAIL=
set BUILD_REQUESTEDFORID=
set BUILD_SOURCEBRANCH=
set BUILD_SOURCEBRANCHNAME=
set BUILD_SOURCESDIRECTORY=
set BUILD_SOURCEVERSION=
set BUILD_SOURCEVERSIONAUTHOR=
set BUILD_SOURCEVERSIONMESSAGE=
set BUILD_STAGINGDIRECTORY=
set CHOCOLATEYINSTALL=
set CHROMEWEBDRIVER=
set COMPUTERNAME=
set DISTRIBUTEDTASK_AGENT_ADDFORCECREDENTIALSTOGITCHECKOUT=
set DISTRIBUTEDTASK_AGENT_AGENTENABLEPIPELINEARTIFACTLARGECHUNKSIZE=
set DISTRIBUTEDTASK_AGENT_CHECKIFTASKNODERUNNERISDEPRECATED246=
set DISTRIBUTEDTASK_AGENT_CONTINUEAFTERCANCELPROCESSTREEKILLATTEMPT=
set DISTRIBUTEDTASK_AGENT_DOCKERACTIONRETRIES=
set DISTRIBUTEDTASK_AGENT_ENABLEADDITIONALMASKINGREGEXES=
set DISTRIBUTEDTASK_AGENT_ENABLEISSUESOURCEVALIDATION=
set DISTRIBUTEDTASK_AGENT_ENABLERESOURCEMONITORDEBUGOUTPUT=
set DISTRIBUTEDTASK_AGENT_ENABLERESOURCEUTILIZATIONWARNINGS=
set DISTRIBUTEDTASK_AGENT_FAILDEPRECATEDBUILDTASK=
set DISTRIBUTEDTASK_AGENT_FAILDEPRECATEDTASK=
set DISTRIBUTEDTASK_AGENT_FAILJOBWHENAGENTDIES=
set DISTRIBUTEDTASK_AGENT_FIXPOSSIBLEGITOUTOFMEMORYPROBLEM=
set DISTRIBUTEDTASK_AGENT_FORCEUPDATETOLATEST2VERSION=
set DISTRIBUTEDTASK_AGENT_IGNOREVSTSTASKLIB=
set DISTRIBUTEDTASK_AGENT_LOGTASKNAMEINUSERAGENT=
set DISTRIBUTEDTASK_AGENT_LOGTOBLOBSTORAGESERVICE=
set DISTRIBUTEDTASK_AGENT_MOUNTWORKSPACE=
set DISTRIBUTEDTASK_AGENT_READONLYVARIABLES=
set DISTRIBUTEDTASK_AGENT_ROSETTA2WARNING=
set DISTRIBUTEDTASK_AGENT_USEDOCKERCOMPOSEV2COMPATIBLEMODE=
set DISTRIBUTEDTASK_AGENT_USEFETCHFILTERINCHECKOUTTASK=
set DISTRIBUTEDTASK_AGENT_USEGITLONGPATHS=
set DISTRIBUTEDTASK_AGENT_USELATESTGITVERSION=
set DISTRIBUTEDTASK_AGENT_USEMSALLIBRARY=
set DISTRIBUTEDTASK_AGENT_USENEWNODEHANDLERTELEMETRY=
set DISTRIBUTEDTASK_AGENT_USENODE20TOSTARTCONTAINER=
set DISTRIBUTEDTASK_AGENT_USESPARSECHECKOUTINCHECKOUTTASK=
set DISTRIBUTEDTASK_AGENT_USEWORKSPACEID=
set DISTRIBUTEDTASK_TASKS_COPYFILESOVERSSHV0USEQUEUE=
set DISTRIBUTEDTASK_TASKS_HIDEDOCKEREXECTASKLOGISSUEERROROUTPUT=
set DISTRIBUTEDTASK_TASKS_MODIFYNUMBEROFRETRIESINROBOCOPY=
set DISTRIBUTEDTASK_TASKS_NODE_SKIPDEBUGLOGSWHENDEBUGMODEOFF=
set DISTRIBUTEDTASK_TASKS_RETIREAZURERMPOWERSHELLMODULE=
set DISTRIBUTEDTASK_TASKS_SKIPHELMMANIFESTNULLPARTS=
set DISTRIBUTEDTASK_TASKS_USEDIGESTIMAGEFROMFILE=
set DISTRIBUTEDTASK_TASKS_USELATESTOPENSSLVERSION=
set DOTNET_MULTILEVEL_LOOKUP=
set DOTNET_NOLOGO=
set DOTNET_SKIP_FIRST_TIME_EXPERIENCE=
set EDGEWEBDRIVER=
set FSHARPINSTALLDIR=
set GECKOWEBDRIVER=
set GOROOT_1_19_X64=
set GOROOT_1_20_X64=
set GOROOT_1_21_X64=
set GOROOT_1_22_X64=
set GOROOT_1_23_X64=
set GOROOT_1_24_X64=
set JAVA_HOME_11_X64=
set JAVA_HOME_17_X64=
set JAVA_HOME_21_X64=
set JAVA_HOME_8_X64=
set LUA_VER=
set NPY_VER=
set PIPX_BIN_DIR=
set PIPX_HOME=
set PIP_CACHE_DIR=
set PIP_IGNORE_INSTALLED=
set PIP_NO_BUILD_ISOLATION=
set PIP_NO_DEPENDENCIES=
set PIP_NO_INDEX=
set PROCESSOR_IDENTIFIER=
set PROCESSOR_REVISION=
set PSMODULEANALYSISCACHEPATH=
set PSMODULEPATH=
set PY3K=
set PYTHONNOUSERSITE=
set PYTHONUNBUFFERED=
set PY_VCRUNTIME_REDIST=
set PY_VER=
set ROSETTA2_WARNING=
set RTOOLS43_HOME=
set RTOOLS44_HOME=
set RTOOLS45_HOME=
set R_VER=
set SBT_HOME=

set aws_checksums=
set aws_crt_cpp=
set aws_c_auth=
set aws_c_cal=
set aws_c_common=
set aws_c_compression=
set aws_c_event_stream=
set aws_c_http=
set aws_c_io=
set aws_c_mqtt=
set aws_c_s3=
set aws_c_sdkutils=
set ffmpeg=
set fftw=
set flatbuffers=
set fmt=
set fontconfig=
set fortran_compiler=
set fortran_compiler_version=
set freeglut=
set freetds=
set freetype=
set freexl=
set fribidi=
set g2clib=
set gcab=
set gdbm=
set gdk_pixbuf=
set geos=
set geotiff=
set getopt_win32=
set gettext=
set gflags=
set giflib=
set gl2ps=
set glew=
set glfw=
set glib=
set glog=
set glpk=
set glslang=
set gmp=
set gnupg=
set gnutls=
set go_compiler=
set go_compiler_version=
set graphite2=
set gsl=
set gstreamer=
set gstreamer_orc=
set gst_plugins_base=
set gst_plugins_good=
set gtest=
set gtk3=
set gts=
set harfbuzz=
set hdf4=
set hdf5=
set hdfeos2=
set hdfeos5=
set hidapi=
set libaec=
set libaio=
set libapr=
set libapriconv=
set libaprutil=
set libarchive=
set libassuan=
set libavif=
set libboost=
set libboost_devel=
set libboost_python=
set libbrotlicommon=
set libbrotlidec=
set libbrotlienc=
set libclang13=
set libclang_cpp14=
set libcrc32c=
set libcryptominisat=
set libcups=
set libcurl=
set libdap4=
set libde265=
set libdeflate=
set libdrm=
set libebm=
set libedit=
set libegl=
set libev=
set libevent=
set libfaiss=
set libffi=
set libflac=
set libflang=
set libgcrypt=
set libgd=
set libgdal=
set libgdal_core=
set libgit2=
set libgl=
set libgles=
set libglib=
set libglu=
set libglvnd=
set libglx=
set libgpg_error=
set libgsasl=
set libgsf=
set libheif=
set libhiredis=
set libhwloc=
set libiconv=
set libidn2=
set libjpeg_turbo=
set libkml=
set libkrb5=
set libksba=
set liblief=
set libllvm19=
set libllvm20=
set libllvm_c19=
set libllvm_c20=
set libmamba=
set libmambapy=
set libmlir19=
set libmlir20=
set libmpdec=
set libmpdecxx=
set libnetcdf=
set libnghttp2=
set libnl=
set libnsl=
set libntlm=
set libnuma=
set libogg=
set libopenblas=
set libopengl=
set libopus=
set libortools=
set libosqp=
set libpcap=
set libpciaccess=
set libpng=
set libpq=
set libqdldl=
set librdkafka=
set libre2_11=
set librsvg=
set libsentencepiece=
set libsndfile=
set libsodium=
set libspatialindex=
set libspatialite=
set libssh2=
set libtasn1=
set libtensorflow=
set libtensorflow_cc=
set libtheora=
set libthrift=
set libtiff=
set libtmglib=
set libtorch=
set libunistring=
set libunwind=
set libutf8proc=
set libuuid=
set libuv=
set libvorbis=
set libvpx=
set libvulkan=
set libwebp=
set libwebp_base=
set libxcb=
set libxkbcommon=
set libxkbfile=
set libxml2=
set libxmlsec1=
set libxslt=
set libzlib=
set libzlib_wapi=
set libzopfli=
set oniguruma=
set onnxruntime_cpp=
set onnxruntime_novec_cpp=
set openblas=
set openblas_devel=
set openh264=
set openjpeg=
set openldap=
set openmpi=
set orc=
set proj=
set ptscotch=
set pugixml=
set pyqt=
set pyqtchart=
set pyqtwebengine=
set python_igraph=
set pytorch=
set py_lief=
set qhull=
set qpdf=
set qt=
set quantlib=
set rdkit=
set rdma_core=
set re2=
set readline=
set reproc=
set reproc_cpp=
set rhash=
set ruby=
set rust_compiler=
set rust_compiler_version=
set rust_gnu_compiler=
set rust_gnu_compiler_version=
set rust_nightly_compiler=
set rust_nightly_compiler_version=
set xcb_util=
set xcb_util_cursor=
set xcb_util_image=
set xcb_util_keysyms=
set xcb_util_renderutil=
set xcb_util_wm=
set xerces_c=
set xorg_libice=
set xorg_libsm=
set xorg_libx11=
set xorg_libxau=
set xorg_libxcomposite=
set xorg_libxcursor=
set xorg_libxdamage=
set xorg_libxdmcp=
set xorg_libxext=
set xorg_libxfixes=
set xorg_libxft=
set xorg_libxi=
set xorg_libxinerama=
set xorg_libxmu=
set xorg_libxrandr=
set xorg_libxrender=
set xorg_libxscrnsaver=
set xorg_libxshmfence=
set xorg_libxt=
set xorg_libxtst=
set xorg_libxxf86vm=
set xorg_xextproto=
set xorg_xorgproto=
set xxhash=
:: show remaining environment variables, in case the list grows enough
:: to run into "/lib/jvm/bin/java: Argument list too long" again.
set

set "BAZEL_BUILD_OPTS=--cxxopt=/std:c++17"
bash -lc "%SRC_DIR%"/compile.sh
if errorlevel 1 exit 1

copy %saved_source_dir%\output\bazel.exe %LIBRARY_BIN%\
